API_DIR := api
TMP_DIR := .gen-tmp

MODULES := auth_public auth_private system user payment
COMMON  := $(API_DIR)/common.api

GOCTL ?= goctl
MODULE_NAME := $(shell awk '/^module /{print $$2}' go.mod)

.PHONY: gen check clean clean-gen gen-all merge-all gen-modules merge-modules fix-imports verify

# ä¸€é”®ç”Ÿæˆ
gen: check clean-gen gen-all merge-all gen-modules merge-modules fix-imports verify clean
	@echo "âœ… generate done"

# æ£€æŸ¥ï¼šå­æ¨¡å— api ä¸èƒ½åŒ…å« syntax/infoï¼ˆåªèƒ½åœ¨ common.apiï¼‰
check:
	@for m in $(MODULES); do \
		if grep -nE '^\s*syntax\s*=' $(API_DIR)/$$m.api >/dev/null 2>&1; then \
			echo "âŒ $(API_DIR)/$$m.api contains 'syntax = ...' (must be only in common.api)"; exit 1; \
		fi; \
		if grep -nE '^\s*info\s*\(' $(API_DIR)/$$m.api >/dev/null 2>&1; then \
			echo "âŒ $(API_DIR)/$$m.api contains 'info(...)' (must be only in common.api)"; exit 1; \
		fi; \
	done
	@echo "âœ… api files check ok"

clean-gen:
	@rm -rf $(TMP_DIR)
	@mkdir -p $(TMP_DIR)

# ç”Ÿæˆå…¨é‡ all.apiï¼šç”¨äºæ›´æ–° routes/types/config/svc/admin.goï¼ˆè¿™äº›è¦†ç›–æ˜¯å®‰å…¨çš„ï¼‰
gen-all:
	@{ \
		set -e; \
		out="$(TMP_DIR)/all.api"; \
		: > "$$out"; \
		cat "$(COMMON)" >> "$$out"; \
		for m in $(MODULES); do \
			f="$(API_DIR)/$$m.api"; \
			test -f "$$f" || { echo "âŒ missing api file: $$f"; exit 1; }; \
			cat "$$f" >> "$$out"; \
		done; \
	}
	@$(GOCTL) api go -api $(TMP_DIR)/all.api -dir $(TMP_DIR)/all


# åˆå¹¶å…¨é‡äº§ç‰©ï¼ˆè¦†ç›–æ›´æ–°ï¼šroutes/types/config/svc/admin.goï¼‰
merge-all:
	@test -f $(TMP_DIR)/all/admin.go || (echo "âŒ gen-all failed: admin.go not found"; exit 1)
	@mkdir -p internal/handler internal/types internal/config internal/svc etc
	@cp -f $(TMP_DIR)/all/internal/handler/routes.go internal/handler/routes.go
	@cp -f $(TMP_DIR)/all/internal/types/types.go internal/types/types.go
	@cp -n $(TMP_DIR)/all/internal/config/config.go internal/config/config.go 2>/dev/null || true
	@rsync -a --ignore-existing $(TMP_DIR)/all/internal/svc/ internal/svc/
	@cp -n $(TMP_DIR)/all/admin.go admin.go 2>/dev/null || true
	@cp -n $(TMP_DIR)/all/etc/*.yaml etc/ 2>/dev/null || true
	@cp -n $(TMP_DIR)/all/go.mod go.mod 2>/dev/null || true
	@cp -n $(TMP_DIR)/all/go.sum go.sum 2>/dev/null || true

# æ¯ä¸ªæ¨¡å—å•ç‹¬ç”Ÿæˆåˆ° tmpï¼šç”¨äºâ€œåªåˆå¹¶æ–°å¢ handler/logicï¼ˆä¸è¦†ç›–ä½ å†™è¿‡çš„ï¼‰â€
gen-modules:
	@for m in $(MODULES); do \
		mkdir -p $(TMP_DIR)/$$m; \
		cat $(COMMON) $(API_DIR)/$$m.api > $(TMP_DIR)/$$m/$$m.api; \
		$(GOCTL) api go -api $(TMP_DIR)/$$m/$$m.api -dir $(TMP_DIR)/$$m/out; \
	done

# handler/logic åªæ‹·è´ä¸å­˜åœ¨çš„æ–‡ä»¶ï¼ˆignore-existingï¼‰ï¼Œé¿å…è¦†ç›–ä½ å†™è¿‡çš„ä»£ç 
merge-modules:
	@for m in $(MODULES); do \
		mkdir -p internal/handler/$$m internal/logic/$$m; \
		rsync -a --ignore-existing $(TMP_DIR)/$$m/out/internal/handler/$$m/ internal/handler/$$m/ 2>/dev/null || true; \
		rsync -a --ignore-existing $(TMP_DIR)/$$m/out/internal/logic/$$m/   internal/logic/$$m/   2>/dev/null || true; \
	done

# è‡ªåŠ¨ä¿®å¤æ‰€æœ‰ go æ–‡ä»¶é‡Œçš„ä¸´æ—¶ importï¼ˆåŒ…å« admin.go / internal/svc / internal/logic ç­‰ï¼‰
fix-imports:
	@echo "ğŸ”§ Fixing .gen-tmp imports to $(MODULE_NAME)/internal/..."
	@# â‘  ä¿®å¤ .gen-tmp/all/internal/xxx -> internal/xxx
	@find . -name "*.go" -type f -print0 | xargs -0 sed -i \
	  's#$(MODULE_NAME)/\.gen-tmp/all/internal/#$(MODULE_NAME)/internal/#g'
	@# â‘¡ ä¿®å¤ .gen-tmp/<mod>/out/internal/xxx -> internal/xxx
	@find . -name "*.go" -type f -print0 | xargs -0 sed -i \
	  's#$(MODULE_NAME)/\.gen-tmp/[^"]*/out/internal/#$(MODULE_NAME)/internal/#g'
	@echo "âœ… imports fixed"

# éªŒè¯ï¼šå·¥ç¨‹é‡Œä¸å…è®¸å†å‡ºç° .gen-tmp import
verify:
	@echo "ğŸ” Verifying no .gen-tmp imports in *.go ..."
	@# å…è®¸ .gen-tmp ç›®å½•å­˜åœ¨ï¼Œä½†ä¸å…è®¸è¢« import
	@if grep -R --line-number --include="*.go" "\.gen-tmp" . >/dev/null 2>&1; then \
		echo "âŒ Found .gen-tmp references in Go files:"; \
		grep -R --line-number --include="*.go" "\.gen-tmp" .; \
		exit 1; \
	else \
		echo "âœ… no .gen-tmp imports"; \
	fi

# æ¸…ç†ä¸´æ—¶ç›®å½•
clean:
	@rm -rf $(TMP_DIR)
