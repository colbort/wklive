GOCTL ?= goctl

# å½“å‰æœåŠ¡ moduleï¼ˆå¿…é¡»ä¸ä½  services/system/go.mod çš„ module ä¸€è‡´ï¼‰
MODULE := wklive/services/system

# ä»“åº“æ ¹ç›®å½•ï¼ˆä» services/system å¾€ä¸Šä¸¤çº§ï¼‰
REPO_ROOT := ../..

# proto æ‰€åœ¨ä½ç½®ï¼ˆå±äº rpc/system æ¨¡å—ï¼‰
PROTO := $(REPO_ROOT)/rpc/system/system.proto

.PHONY: gen gen-rpc fix-imports tidy fmt clean-gen

gen: gen-rpc fix-imports fmt tidy clean-gen

# ä¸€é”®ï¼šç”Ÿæˆ go-zero rpc æœåŠ¡éª¨æ¶ + ä¿®å¤ import + gofmt + go mod tidy
gen-rpc:
	@echo "ğŸ”§ [services/system] goctl rpc protoc..."
	$(GOCTL) rpc protoc $(PROTO) \
		--proto_path=$(REPO_ROOT) \
		--module=$(MODULE) \
		--go_out=. \
		--go-grpc_out=. \
		--zrpc_out=. \
		--style=gozero
	@$(MAKE) fix-imports
	@$(MAKE) fmt
	@$(MAKE) tidy
	@echo "âœ… [services/system] gen-rpc done"

# ä¿®å¤ goctl å¯èƒ½ç”Ÿæˆçš„é”™è¯¯ import è·¯å¾„/åˆ«å
fix-imports:
	@echo "ğŸ”§ [services/system] fixing imports..."
	@# 1) æŠŠä»»ä½•å½¢å¦‚ ".../wklive/rpc/system" çš„é”™è¯¯å‰ç¼€ç»Ÿä¸€æ”¹æˆ "wklive/rpc/system"
	@# å¸¸è§é”™è¯¯ï¼šwklive/services/system/wklive/rpc/system
	@find . -name "*.go" -type f -print0 | xargs -0 sed -i \
		's#"$(MODULE)/wklive/rpc/system"#"wklive/rpc/system"#g'
	@find . -name "*.go" -type f -print0 | xargs -0 sed -i \
		's#"wklive/services/system/wklive/rpc/system"#"wklive/rpc/system"#g'
	@# 2) ä¿®å¤ goctl ç”Ÿæˆçš„åŒ…åˆ«å system_system.xxx -> system.xxxï¼ˆå¦‚æœæœ‰ï¼‰
	@find . -name "*.go" -type f -print0 | xargs -0 sed -i \
		's/system_system\./system\./g'
	@echo "âœ… [services/system] imports fixed"

fmt:
	@echo "ğŸ”§ [services/system] gofmt..."
	@gofmt -w $$(find . -name "*.go" -type f)

tidy:
	@echo "ğŸ”§ [services/system] go mod tidy..."
	@go mod tidy

# è°¨æ…ï¼šåªæ¸…ç† goctl ç”Ÿæˆçš„ server ç›®å½•ï¼ˆé¿å…è¯¯åˆ ä½ å†™çš„ logicï¼‰
clean-gen:
	@rm -rf wklive/

.PHONY: gen-model
gen-model:
	goctl model mysql ddl --src system.sql --dir ./models
